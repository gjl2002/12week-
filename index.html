<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>12-Week Fitness Final (Fixed)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* åŸºç¡€è‰²ç›˜ */
            --accent-color: #ff2d55; /* é»˜è®¤ä¸»è‰² */
            --bg-page: transparent; 
            
            /* å¡ç‰‡èƒŒæ™¯ */
            --bg-card: rgba(255, 255, 255, 0.94);
            --bg-card-hover: rgba(255, 255, 255, 1);
            --border-card: rgba(0, 0, 0, 0.06);
            --glass-blur: blur(24px);
            
            /* è½¨é“é¢œè‰² (æ›´æ·¡ã€æ›´ç»†) */
            --track-bg: rgba(0, 0, 0, 0.08);

            /* é˜´å½± */
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.05);
            
            /* å˜é‡ */
            --gap: 12px;
            --radius: 24px;
            --pad: 20px;
            
            /* å¼¹çª—ä¸“ç”¨ */
            --modal-bg: #ffffff;
            --modal-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
        }

        /* æ·±è‰²æ¨¡å¼ */
        :root[data-theme="dark"] {
            --bg-card: rgba(30, 30, 32, 0.88);
            --bg-card-hover: rgba(44, 44, 46, 0.96);
            --border-card: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --track-bg: rgba(255, 255, 255, 0.15);
            --shadow-card: 0 8px 30px rgba(0, 0, 0, 0.4);
            --modal-bg: #1c1c1e;
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            margin: 0; min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            background: var(--bg-page);
            font-family: "SF Pro Display", "SF Pro Text", "Inter", -apple-system, system-ui, sans-serif;
            color: var(--text-main);
            padding: 10px; overflow: hidden;
            transition: background 0.3s ease;
        }

        .widget-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: var(--gap); }

        /* å¸ƒå±€ */
        .bento-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr; 
            grid-template-rows: auto auto; 
            gap: var(--gap);
            transition: all 0.4s ease;
        }
        .bento-grid[data-layout="list"] { grid-template-columns: 1fr; }

        /* å¡ç‰‡åŸºç¡€ */
        .card {
            background: var(--bg-card);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--border-card);
            border-radius: var(--radius);
            padding: var(--pad);
            box-shadow: var(--shadow-card);
            transition: transform 0.2s ease, background 0.3s ease;
            position: relative;
            display: flex; flex-direction: column;
            overflow: visible; 
        }
        .card:hover { transform: translateY(-2px); background: var(--bg-card-hover); }

        /* 1. æ§åˆ¶æ  */
        .header-ctrls {
            display: flex; gap: 8px; position: absolute; top: 18px; right: 18px; z-index: 50;
            opacity: 0.3; transition: opacity 0.2s; 
        }
        .card:hover .header-ctrls, .header-ctrls:hover { opacity: 1; }
        
        .ctrl-btn {
            width: 28px; height: 28px; border-radius: 50%; border: none;
            background: rgba(128,128,128, 0.15); color: var(--text-muted);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 13px; padding: 0; margin: 0;
            transition: transform 0.2s, background 0.2s;
        }
        .ctrl-btn:hover { transform: scale(1.1); background: var(--accent-color); color: #fff; }
        .ctrl-btn--color { background-color: var(--bg-swatch) !important; border: 1px solid rgba(0,0,0,0.1); }

        /* 2. æ—¶é’Ÿå¡ç‰‡ */
        .card--clock { grid-column: 1 / 2; justify-content: space-between; min-height: 130px; }
        .bento-grid[data-layout="list"] .card--clock { grid-column: 1 / -1; min-height: auto; flex-direction: row; align-items: center; padding-right: 150px; }
        
        .card__label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 4px; }
        .badge {
            display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 99px;
            background: var(--track-bg); color: var(--text-main); font-size: 11px; font-weight: 600;
        }
        .clock-display {
            font-size: clamp(36px, 9vw, 52px); font-weight: 800; font-variant-numeric: tabular-nums;
            letter-spacing: -0.03em; line-height: 1; color: var(--text-main); margin-top: auto;
        }
        .bento-grid[data-layout="list"] .clock-display { margin-top: 0; font-size: 36px; }
        .bento-grid[data-layout="list"] .clock-group { display: flex; align-items: center; gap: 16px; }

        /* 3. æ ¸å¿ƒè¿›åº¦ */
        .card--main {
            grid-column: 2 / 3; grid-row: 1 / 3; 
            background: var(--accent-color);
            color: #fff; border: none; justify-content: space-between; overflow: hidden;
        }
        .bento-grid[data-layout="list"] .card--main { grid-column: 1 / -1; grid-row: auto; flex-direction: row; align-items: center; gap: 16px; padding: 24px; }
        
        .card--main .card__label { color: rgba(255,255,255, 0.75); }
        .main-stat { font-size: clamp(38px, 8vw, 56px); font-weight: 800; line-height: 1; letter-spacing: -0.02em; }
        .bento-grid[data-layout="list"] .main-stat { font-size: 42px; }
        
        .hero-bar { height: 14px; background: rgba(0,0,0, 0.2); border-radius: 99px; overflow: hidden; position: relative; margin-top: 14px; width: 100%; }
        .hero-bar__fill { height: 100%; width: 0%; background: #fff; border-radius: 99px; transition: width 1s ease; }
        .bento-grid[data-layout="list"] .hero-bar-container { flex: 1; min-width: 0; }

        /* 4. åœ†ç¯åŒºåŸŸ (Hover äº¤äº’) */
        .split-row { grid-column: 1 / 2; display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
        .bento-grid[data-layout="list"] .split-row { grid-column: 1 / -1; }

        .card--ring { padding: 16px; align-items: center; justify-content: center; text-align: center; gap: 8px; cursor: default; }
        .bento-grid[data-layout="list"] .card--ring { flex-direction: row; justify-content: space-between; padding: 0 24px; height: 76px; }

        .ring-text-group { display: flex; flex-direction: column; align-items: center; height: 38px; justify-content: center; }
        .bento-grid[data-layout="list"] .ring-text-group { align-items: flex-start; }
        
        .ring-val-pct { display: block; font-size: 18px; font-weight: 700; color: var(--text-main); line-height: 1; }
        .ring-val-days { display: none; font-size: 14px; font-weight: 600; color: var(--accent-color); line-height: 1; }
        
        .card--ring:hover .ring-val-pct { display: none; }
        .card--ring:hover .ring-val-days { display: block; animation: slideUp 0.2s ease; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 5. å…¨æ–°åœ†ç¯ç»“æ„ (ä¿®å¤å¯¹é½ä¸é€æ˜é—®é¢˜) --- */
        .apple-ring-container {
            position: relative; width: 52px; height: 52px;
        }
        /* è½¨é“ç¯ */
        .apple-ring-track {
            position: absolute; inset: 0; border-radius: 50%;
            border: 5px solid var(--track-bg);
        }
        /* è¿›åº¦ç¯ */
        .apple-ring-progress {
            position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(var(--accent-color) var(--deg), transparent 0deg);
            /* ä½¿ç”¨ mask é•‚ç©ºä¸­å¿ƒ */
            -webkit-mask: radial-gradient(transparent 60%, black 62%);
            mask: radial-gradient(transparent 60%, black 62%);
            opacity: 0; transition: opacity 0.3s;
        }
        /* åœ†çƒ (å®Œç¾å¯¹é½) */
        .apple-ring-sphere {
            position: absolute;
            top: 50%; left: 50%;
            width: 5px; height: 5px;
            margin: -2.5px 0 0 -2.5px; /* è‡ªèº«å±…ä¸­ */
            background: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 2px rgba(0,0,0,0.15);
            /* å…ˆæ—‹è½¬è§’åº¦ï¼Œå†å‘å¤–å¹³ç§»åŠå¾„è·ç¦» (52px/2 - 5px/2 = 23.5px) */
            transform: rotate(var(--deg)) translateY(-23.5px);
            opacity: 0; transition: opacity 0.3s;
        }

        /* --- 6. æ¯æ—¥å¼•è¨€ (å›å½’) --- */
        .quote-card {
            text-align: center; padding: 8px 0;
        }
        .quote-text {
            font-size: 13px; color: var(--text-muted); font-style: italic; margin: 0; opacity: 0.8;
            transition: opacity 0.5s;
        }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .modal[aria-hidden="false"] { display: flex; animation: fadeIn 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal__card { 
            background: var(--modal-bg); 
            padding: 24px; border-radius: 20px; 
            width: 340px; max-width: 90vw;
            box-shadow: var(--modal-shadow); 
        }
        .modal__title { margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: var(--text-main); }
        .modal__actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        
        .btn-modal { 
            padding: 8px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; 
            transition: transform 0.1s;
        }
        .btn-modal:active { transform: scale(0.96); }
        .btn-primary { background: #4cd964; color: #fff; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--track-bg); }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .picker-preview { height: 40px; border-radius: 10px; margin-bottom: 16px; border: 1px solid rgba(0,0,0,0.1); transition: background 0.3s; }
        .picker-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .color-dot { 
            width: 32px; height: 32px; border-radius: 50%; cursor: pointer; 
            border: 2px solid transparent; box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
            transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { border-color: #fff; outline: 2px solid var(--text-muted); }

        /* æ—¥å†é€‰æ‹©å™¨ */
        .cal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .cal-title { font-weight: 700; font-size: 16px; }
        .cal-btn { background: transparent; border: 1px solid var(--track-bg); border-radius: 8px; width: 32px; height: 32px; cursor: pointer; color: var(--text-main); }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .cal-dow { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .cal-day { 
            height: 36px; display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; font-size: 14px; cursor: pointer; color: var(--text-main);
        }
        .cal-day:hover { background: var(--track-bg); }
        .cal-day.selected { background: #4cd964; color: #fff; font-weight: 600; }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        @media (max-width: 400px) {
            .bento-grid { grid-template-columns: 1fr !important; }
            .card--main { grid-column: 1 / -1 !important; grid-row: auto !important; }
            .split-row { grid-column: 1 / -1 !important; }
            .card--clock { grid-column: 1 / -1 !important; }
        }
    </style>
</head>
<body>

<div class="widget-container">
    <div class="bento-grid" id="main-grid" data-layout="grid">
        <!-- 1. æ—¶é’Ÿ -->
        <div class="card card--clock">
            <div class="header-ctrls">
                <button id="btn-layout" class="ctrl-btn" title="å¸ƒå±€">âš</button>
                <button id="btn-primary" class="ctrl-btn ctrl-btn--color" title="ä¸»è‰²"></button>
                <button id="btn-bg" class="ctrl-btn ctrl-btn--color" title="èƒŒæ™¯"></button>
                <button id="btn-12w" class="ctrl-btn" title="æ—¥æœŸ">ğŸ“…</button>
                <button id="btn-theme" class="ctrl-btn" title="æ·±è‰²">ğŸŒ—</button>
            </div>
            <div class="clock-group">
                <div class="clock-label-group">
                    <div class="card__label">Current Time</div>
                    <div id="week-badge" class="badge">W1</div>
                </div>
                <div id="clock" class="clock-display">00:00</div>
            </div>
        </div>

        <!-- 2. æ ¸å¿ƒå¡ç‰‡ -->
        <div class="card card--main">
            <div>
                <div class="card__label">12 Week Year</div>
                <div class="main-stat" id="pct-12w">0%</div>
                <div class="card__label" style="color:rgba(255,255,255,0.8); margin-top:4px">
                    <span id="weeks-12w-num">1</span>/12 å‘¨ Â· å‰© <span id="days-12w-left">0</span> å¤©
                </div>
            </div>
            <div class="hero-bar-container">
                <div class="hero-bar">
                    <div id="bar-12w" class="hero-bar__fill"></div>
                </div>
            </div>
        </div>

        <!-- 3. åœ†ç¯ (æ–°ç»“æ„) -->
        <div class="split-row">
            <div class="card card--ring">
                <div class="ring-text-group">
                    <div class="card__label">Year</div>
                    <div class="ring-val-pct" id="txt-year">0%</div>
                    <div class="ring-val-days" id="days-year">å‰©0å¤©</div>
                </div>
                <div class="apple-ring-container">
                    <div class="apple-ring-track"></div>
                    <div class="apple-ring-progress" id="ring-progress-year"></div>
                    <div class="apple-ring-sphere" id="ring-sphere-year"></div>
                </div>
            </div>
            <div class="card card--ring">
                <div class="ring-text-group">
                    <div class="card__label">Week</div>
                    <div class="ring-val-pct" id="txt-week">0%</div>
                    <div class="ring-val-days" id="days-week">å‰©0å¤©</div>
                </div>
                <div class="apple-ring-container">
                    <div class="apple-ring-track"></div>
                    <div class="apple-ring-progress" id="ring-progress-week"></div>
                    <div class="apple-ring-sphere" id="ring-sphere-week"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. æ¯æ—¥å¼•è¨€ (å›å½’) -->
    <footer class="quote-card">
        <p id="quote-text" class="quote-text">Loading...</p>
    </footer>
</div>

<!-- å¼¹çª— (ä¿æŒä¸å˜) -->
<div id="modal-primary" class="modal" aria-hidden="true">
    <div class="modal__card">
        <h3 class="modal__title">é€‰æ‹©ä¸»è‰²</h3>
        <div id="preview-primary" class="picker-preview" style="background:var(--accent-color)"></div>
        <div class="picker-grid" id="grid-primary"></div>
        <div class="modal__actions">
            <button class="btn-modal btn-ghost" data-close="#modal-primary">å–æ¶ˆ</button>
            <button class="btn-modal btn-primary" id="save-primary">ç¡®å®š</button>
        </div>
    </div>
</div>
<div id="modal-bg" class="modal" aria-hidden="true">
    <div class="modal__card">
        <h3 class="modal__title">é€‰æ‹©èƒŒæ™¯è‰²</h3>
        <div id="preview-bg" class="picker-preview" style="background:var(--bg-page); border:1px solid #eee"></div>
        <div class="picker-grid" id="grid-bg"></div>
        <div class="modal__actions">
            <button class="btn-modal btn-ghost" data-close="#modal-bg">å–æ¶ˆ</button>
            <button class="btn-modal btn-primary" id="save-bg">ç¡®å®š</button>
        </div>
    </div>
</div>
<div id="modal-cal" class="modal" aria-hidden="true">
    <div class="modal__card">
        <h3 class="modal__title">è®¾ç½® 12 å‘¨èµ·å§‹æ—¥</h3>
        <div class="cal-head">
            <button class="cal-btn" id="cal-prev">â€¹</button>
            <div class="cal-title" id="cal-title"></div>
            <button class="cal-btn" id="cal-next">â€º</button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
        <div class="modal__actions">
            <button class="btn-modal btn-ghost" data-close="#modal-cal">å–æ¶ˆ</button>
            <button class="btn-modal btn-primary" id="save-cal">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
// --- æ ¸å¿ƒé€»è¾‘ ---
const LS = {
    get: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch(e) { return d; } },
    set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }
};

// å¼•è¨€æ•°æ®
const DEFAULT_QUOTES = [
    'ç”¨12å‘¨æ—¶é—´å®Œæˆ1å¹´ç›®æ ‡', 'æˆä¸ºè‡ªå·±äººç”Ÿçš„å¤´å·ç©å®¶', 'å°‘å³æ˜¯å¤šï¼Œæ…¢å³æ˜¯å¿«',
    'æˆ‘æƒ³è®©ä¸–ç•Œä¸ºæˆ‘æƒŠå¹', 'ä½ åªæ´»ä¸€æ¬¡ã€‚ä½¿å®ƒæœ‰æ„ä¹‰', 'ä½ é¡»å¯»å¾—ä½ æ‰€çˆ±ï¼Œå¹¶ä¸ºä¹‹å®ˆæœ›',
    'å­¦ä¹ çš„æœ¬è´¨å°±æ˜¯æè‡´çš„é‡å¤', 'åˆ›æ„å°±æ˜¯æŠŠäº‹ç‰©è”ç³»èµ·æ¥', 'æŠŠæ³¨æ„åŠ›æ”¾åœ¨å¯æ§çš„äº‹æƒ…ä¸Š'
];
let quoteIndex = 0;

function two(n){return String(n).padStart(2,'0')}

// æ›´æ–°åœ†ç¯ (æ–°é€»è¾‘)
function updateRing(progressId, sphereId, pct) {
    const deg = (pct / 100) * 360;
    const progressEl = document.getElementById(progressId);
    const sphereEl = document.getElementById(sphereId);
    
    if (progressEl && sphereEl) {
        progressEl.style.setProperty('--deg', `${deg}deg`);
        sphereEl.style.setProperty('--deg', `${deg}deg`);
        // åªæœ‰è¿›åº¦å¤§äº0æ—¶æ‰æ˜¾ç¤ºè¿›åº¦æ¡å’Œåœ†çƒ
        const opacity = pct > 0 ? 1 : 0;
        progressEl.style.opacity = opacity;
        sphereEl.style.opacity = opacity;
    }
}

function update(){
    const now = new Date();
    document.getElementById('clock').textContent = `${two(now.getHours())}:${two(now.getMinutes())}`;
    
    // 12 Week Logic
    const urlParams = new URLSearchParams(window.location.search);
    const startStr = urlParams.get('start') || LS.get('start12w', null);
    const startDate = startStr ? new Date(startStr) : new Date(now.getFullYear(), now.getMonth(), 1);
    
    const s = new Date(startDate.getFullYear(),startDate.getMonth(),startDate.getDate());
    const e = new Date(s); e.setDate(s.getDate()+84);
    const totalMs = e-s; 
    const passed = now-s;
    let pct12 = Math.max(0, Math.min(1, passed/totalMs)) * 100;
    
    document.getElementById('week-badge').textContent = `W${Math.max(1, Math.ceil(passed/(7*86400000)))}`;
    document.getElementById('pct-12w').textContent = `${pct12.toFixed(1)}%`;
    document.getElementById('bar-12w').style.width = `${pct12}%`;
    document.getElementById('weeks-12w-num').textContent = Math.ceil(passed/(7*86400000));
    document.getElementById('days-12w-left').textContent = Math.max(0, Math.ceil((e-now)/86400000));
    
    // Year
    const yS = new Date(now.getFullYear(),0,1);
    const yE = new Date(now.getFullYear()+1,0,1);
    const yPct = Math.max(0, Math.min(100, ((now-yS)/(yE-yS))*100));
    updateRing('ring-progress-year', 'ring-sphere-year', yPct);
    document.getElementById('txt-year').textContent = `${yPct.toFixed(0)}%`;
    document.getElementById('days-year').textContent = `å‰©${Math.ceil((yE-now)/86400000)}å¤©`;

    // Week
    const d = (now.getDay()+6)%7;
    const wS = new Date(now); wS.setHours(0,0,0,0); wS.setDate(now.getDate()-d);
    const wE = new Date(wS); wE.setDate(wS.getDate()+7);
    const wPct = Math.max(0, Math.min(100, ((now-wS)/(7*86400000))*100));
    updateRing('ring-progress-week', 'ring-sphere-week', wPct);
    document.getElementById('txt-week').textContent = `${wPct.toFixed(0)}%`;
    document.getElementById('days-week').textContent = `å‰©${Math.max(0, Math.ceil((wE-now)/86400000))}å¤©`;
}

function applySettings(theme) {
    const pColor = LS.get(`primary:${theme}`, '#ff2d55');
    document.documentElement.style.setProperty('--accent-color', pColor);
    document.getElementById('btn-primary').style.setProperty('--bg-swatch', pColor);

    const bgVal = LS.get(`bg:${theme}`, theme==='dark'?'#000000':'transparent');
    document.documentElement.style.setProperty('--bg-page', bgVal);
    document.getElementById('btn-bg').style.setProperty('--bg-swatch', bgVal);
}

// --- å¼¹çª—é€»è¾‘ (ä¿æŒä¸å˜) ---
const COLORS = ['#ff2d55', '#ff9500', '#ffcc00', '#4cd964', '#5ac8fa', '#007aff', '#5856d6', '#ff3b30', '#8e8e93', '#333333'];
const BG_COLORS = ['transparent', '#ffffff', '#f2f2f7', '#e5e5e5', '#000000', '#1c1c1e', '#2c2c2e'];

function renderColorGrid(gridId, colors, currentVal, previewId) {
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';
    let selected = currentVal;
    colors.forEach(c => {
        const dot = document.createElement('div'); dot.className = 'color-dot'; dot.style.background = c;
        if(c === 'transparent') dot.style.backgroundImage = 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)';
        if(c === selected) dot.classList.add('active');
        dot.onclick = () => {
            selected = c; document.getElementById(previewId).style.background = c;
            grid.querySelectorAll('.color-dot').forEach(el => el.classList.remove('active')); dot.classList.add('active');
        };
        grid.appendChild(dot);
    });
    return () => selected;
}

let calDate = new Date();
function renderCalendar() {
    const title = document.getElementById('cal-title'); const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
    title.textContent = `${calDate.getFullYear()}.${two(calDate.getMonth()+1)}`;
    ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].forEach(d => { const el = document.createElement('div'); el.className='cal-dow'; el.textContent=d; grid.appendChild(el); });
    const firstDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1);
    const startIdx = (firstDay.getDay() + 6) % 7; 
    const daysInMonth = new Date(calDate.getFullYear(), calDate.getMonth()+1, 0).getDate();
    for(let i=0; i<startIdx; i++) grid.appendChild(document.createElement('div'));
    const savedStr = LS.get('start12w', ''); const savedDate = savedStr ? new Date(savedStr) : new Date();
    for(let d=1; d<=daysInMonth; d++) {
        const el = document.createElement('div'); el.className = 'cal-day'; el.textContent = d;
        if(calDate.getFullYear()===savedDate.getFullYear() && calDate.getMonth()===savedDate.getMonth() && savedDate.getDate()===d) el.classList.add('selected');
        el.onclick = () => {
            savedDate.setFullYear(calDate.getFullYear(), calDate.getMonth(), d);
            LS.set('start12w', `${savedDate.getFullYear()}-${two(savedDate.getMonth()+1)}-${two(savedDate.getDate())}`);
            renderCalendar();
        };
        grid.appendChild(el);
    }
}

window.addEventListener('DOMContentLoaded', ()=>{
    const theme = LS.get('theme', 'light');
    document.documentElement.setAttribute('data-theme', theme);
    applySettings(theme);

    const grid = document.getElementById('main-grid'); const lBtn = document.getElementById('btn-layout');
    let l = LS.get('layout', 'grid'); grid.setAttribute('data-layout', l);
    lBtn.onclick = () => { l = l==='grid'?'list':'grid'; grid.setAttribute('data-layout', l); LS.set('layout', l); };

    const openModal = (id) => document.getElementById(id).setAttribute('aria-hidden', 'false');
    const closeModal = (id) => document.getElementById(id).setAttribute('aria-hidden', 'true');
    document.querySelectorAll('[data-close]').forEach(btn => btn.onclick = () => closeModal(btn.getAttribute('data-close')));

    let getSelectedPrimary;
    document.getElementById('btn-primary').onclick = () => {
        const t = document.documentElement.getAttribute('data-theme'); const cur = LS.get(`primary:${t}`, '#ff2d55');
        document.getElementById('preview-primary').style.background = cur;
        getSelectedPrimary = renderColorGrid('grid-primary', COLORS, cur, 'preview-primary'); openModal('modal-primary');
    };
    document.getElementById('save-primary').onclick = () => {
        const val = getSelectedPrimary(); const t = document.documentElement.getAttribute('data-theme');
        LS.set(`primary:${t}`, val); applySettings(t); closeModal('modal-primary');
    };

    let getSelectedBg;
    document.getElementById('btn-bg').onclick = () => {
        const t = document.documentElement.getAttribute('data-theme'); const cur = LS.get(`bg:${t}`, 'transparent');
        document.getElementById('preview-bg').style.background = cur;
        getSelectedBg = renderColorGrid('grid-bg', BG_COLORS, cur, 'preview-bg'); openModal('modal-bg');
    };
    document.getElementById('save-bg').onclick = () => {
        const val = getSelectedBg(); const t = document.documentElement.getAttribute('data-theme');
        LS.set(`bg:${t}`, val); applySettings(t); closeModal('modal-bg');
    };

    document.getElementById('btn-12w').onclick = () => {
        const savedStr = LS.get('start12w', ''); calDate = savedStr ? new Date(savedStr) : new Date();
        renderCalendar(); openModal('modal-cal');
    };
    document.getElementById('cal-prev').onclick = () => { calDate.setMonth(calDate.getMonth()-1); renderCalendar(); };
    document.getElementById('cal-next').onclick = () => { calDate.setMonth(calDate.getMonth()+1); renderCalendar(); };
    document.getElementById('save-cal').onclick = () => { update(); closeModal('modal-cal'); };

    document.getElementById('btn-theme').onclick = () => {
        const cur = document.documentElement.getAttribute('data-theme'); const next = cur==='light'?'dark':'light';
        document.documentElement.setAttribute('data-theme', next); LS.set('theme', next); applySettings(next);
    };

    // å¼•è¨€è½®æ’­
    const quotes = LS.get('quotes', DEFAULT_QUOTES);
    const qEl = document.getElementById('quote-text');
    const setQuote = () => {
        qEl.style.opacity = 0;
        setTimeout(() => { qEl.textContent = quotes[quoteIndex % quotes.length]; qEl.style.opacity = 0.8; }, 500);
    };
    setQuote();
    setInterval(() => { quoteIndex = (quoteIndex + 1) % quotes.length; setQuote(); }, 8000);

    update(); setInterval(update, 1000);
});
</script>
</body>
</html>